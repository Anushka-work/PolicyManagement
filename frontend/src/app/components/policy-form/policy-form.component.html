<div class="form-wrapper">
  <div class="form-header">
    <h1>{{ isViewMode ? 'View Policy Details' : (isEditMode ? 'Edit Policy' : 'Create New Policy') }}</h1>
    <p class="subtitle">{{ isViewMode ? 'Policy information (read-only)' : (isEditMode ? 'Update policy information' : 'Fill in the details to create a new policy') }}</p>
  </div>

  <!-- Step Navigator -->
  <div class="steps-container" *ngIf="!isViewMode">
    <p-steps [model]="steps" [(activeIndex)]="currentStep" [readonly]="true"></p-steps>
  </div>

  <p-message *ngIf="errorMessage" severity="error" [text]="errorMessage" styleClass="error-message"></p-message>

  <form [formGroup]="policyForm" (ngSubmit)="onSubmit()">
    
    <!-- Step 1: Policy Information -->
    <div class="form-section" *ngIf="currentStep === 0 || isViewMode">
      <div class="section-header">
        <div class="step-indicator">
          <span class="step-number">1</span>
        </div>
        <div class="section-title">
          <h2>Policy Information</h2>
          <p class="step-description">Basic policy details and coverage information</p>
        </div>
      </div>
      <div class="form-grid">
        <!-- User Selection (SUPERUSER only, Create mode only) -->
        <div class="form-field full-width" *ngIf="authService.isSuperUser() && !isEditMode && !isViewMode">
          <label for="userId">Select User <span class="required">*</span></label>
          <p-dropdown 
            formControlName="userId"
            inputId="userId"
            [options]="users"
            optionLabel="label"
            optionValue="value"
            [filter]="true"
            filterBy="label"
            placeholder="Select user to create policy for"
            [disabled]="loadingUsers">
          </p-dropdown>
          <small *ngIf="loadingUsers" class="info-text">Loading users...</small>
          <small class="error-text" *ngIf="f['userId'] && f['userId'].invalid && (f['userId'].dirty || f['userId'].touched)">
            Please select a user
          </small>
        </div>

        <div class="form-field">
          <label for="planType">Plan Type <span class="required">*</span></label>
          <p-dropdown 
            formControlName="planType"
            inputId="planType"
            [options]="planTypes" 
            optionLabel="label" 
            optionValue="value"
            placeholder="Select Plan Type">
          </p-dropdown>
          <small class="error-text" *ngIf="f['planType'].invalid && (f['planType'].dirty || f['planType'].touched)">
            Plan type is required
          </small>
        </div>

        <div class="form-field">
          <label for="tenure">Tenure (Years) <span class="required">*</span></label>
          <p-inputNumber 
            formControlName="tenure"
            inputId="tenure"
            [min]="1"
            placeholder="Enter tenure">
          </p-inputNumber>
          <small class="error-text" *ngIf="f['tenure'].invalid && (f['tenure'].dirty || f['tenure'].touched)">
            <span *ngIf="f['tenure'].errors?.['required']">Tenure is required</span>
            <span *ngIf="f['tenure'].errors?.['min']">Minimum 1 year</span>
          </small>
        </div>

        <div class="form-field">
          <label for="premiumFrequency">Premium Frequency <span class="required">*</span></label>
          <p-dropdown 
            formControlName="premiumFrequency"
            inputId="premiumFrequency"
            [options]="premiumFrequencies" 
            optionLabel="label" 
            optionValue="value"
            placeholder="Select Frequency">
          </p-dropdown>
          <small class="error-text" *ngIf="f['premiumFrequency'].invalid && (f['premiumFrequency'].dirty || f['premiumFrequency'].touched)">
            Premium frequency is required
          </small>
        </div>

        <div class="form-field">
          <label for="insuredAmount">Insured Amount <span class="required">*</span></label>
          <p-inputNumber 
            formControlName="insuredAmount"
            inputId="insuredAmount"
            mode="currency"
            currency="USD"
            locale="en-US"
            placeholder="Enter amount">
          </p-inputNumber>
          <small class="error-text" *ngIf="f['insuredAmount'].invalid && (f['insuredAmount'].dirty || f['insuredAmount'].touched)">
            <span *ngIf="f['insuredAmount'].errors?.['required']">Insured amount is required</span>
            <span *ngIf="f['insuredAmount'].errors?.['min']">Must be greater than 0</span>
          </small>
        </div>

        <div class="form-field">
          <label for="issuanceDate">Issuance Date <span class="required">*</span></label>
          <p-calendar 
            formControlName="issuanceDate"
            inputId="issuanceDate"
            [showIcon]="true"
            dateFormat="yy-mm-dd"
            placeholder="Select date">
          </p-calendar>
          <small class="error-text" *ngIf="f['issuanceDate'].invalid && (f['issuanceDate'].dirty || f['issuanceDate'].touched)">
            Issuance date is required
          </small>
        </div>

        <div class="form-field">
          <label for="maturityDate">Maturity Date <span class="required">*</span></label>
          <p-calendar 
            formControlName="maturityDate"
            inputId="maturityDate"
            [showIcon]="true"
            dateFormat="yy-mm-dd"
            placeholder="Select date">
          </p-calendar>
          <small class="error-text" *ngIf="f['maturityDate'].invalid && (f['maturityDate'].dirty || f['maturityDate'].touched)">
            Maturity date is required
          </small>
        </div>

        <div class="form-field" *ngIf="isEditMode">
          <label for="policyStatus">Policy Status <span class="required">*</span></label>
          <p-dropdown 
            formControlName="policyStatus"
            inputId="policyStatus"
            [options]="statusOptions" 
            optionLabel="label" 
            optionValue="value"
            placeholder="Select Status">
          </p-dropdown>
          <small class="error-text" *ngIf="f['policyStatus'].invalid && (f['policyStatus'].dirty || f['policyStatus'].touched)">
            Policy status is required
          </small>
        </div>
      </div>
    </div>

    <!-- Step 2: Policy Holder Information -->
    <div class="form-section" *ngIf="currentStep === 1 || isViewMode">
      <div class="section-header">
        <div class="step-indicator">
          <span class="step-number">2</span>
        </div>
        <div class="section-title">
          <h2>Policy Holder Information</h2>
          <p class="step-description">Personal details of the policy holder</p>
        </div>
      </div>
      <div class="form-grid">
        <div class="form-field full-width">
          <label for="policyHolderName">Policy Holder Name <span class="required">*</span></label>
          <input 
            pInputText 
            type="text" 
            formControlName="policyHolderName"
            id="policyHolderName"
            placeholder="Enter full name">
          <small class="error-text" *ngIf="f['policyHolderName'].invalid && (f['policyHolderName'].dirty || f['policyHolderName'].touched)">
            <span *ngIf="f['policyHolderName'].errors?.['required']">Name is required</span>
            <span *ngIf="f['policyHolderName'].errors?.['minlength']">Minimum 3 characters</span>
          </small>
        </div>

        <div class="form-field">
          <label for="dob">Date of Birth <span class="required">*</span></label>
          <p-calendar 
            formControlName="dob"
            inputId="dob"
            [showIcon]="true"
            dateFormat="yy-mm-dd"
            [maxDate]="maxDate"
            placeholder="Select date">
          </p-calendar>
          <small class="error-text" *ngIf="f['dob'].invalid && (f['dob'].dirty || f['dob'].touched)">
            Date of birth is required
          </small>
        </div>

        <div class="form-field">
          <label for="mobileNumber">Mobile Number <span class="required">*</span></label>
          <input 
            pInputText 
            type="text" 
            formControlName="mobileNumber"
            id="mobileNumber"
            placeholder="10-digit number">
          <small class="error-text" *ngIf="f['mobileNumber'].invalid && (f['mobileNumber'].dirty || f['mobileNumber'].touched)">
            <span *ngIf="f['mobileNumber'].errors?.['required']">Mobile number is required</span>
            <span *ngIf="f['mobileNumber'].errors?.['pattern']">Must be 10 digits</span>
          </small>
        </div>

        <div class="form-field full-width">
          <label for="address">Address <span class="required">*</span></label>
          <textarea 
            pInputTextarea 
            formControlName="address"
            id="address" 
            rows="3" 
            placeholder="Enter full address">
          </textarea>
          <small class="error-text" *ngIf="f['address'].invalid && (f['address'].dirty || f['address'].touched)">
            <span *ngIf="f['address'].errors?.['required']">Address is required</span>
            <span *ngIf="f['address'].errors?.['minlength']">Minimum 5 characters</span>
          </small>
        </div>
      </div>
    </div>

    <!-- Step 3: Income Information -->
    <div class="form-section" *ngIf="currentStep === 2 || isViewMode">
      <div class="section-header">
        <div class="step-indicator">
          <span class="step-number">3</span>
        </div>
        <div class="section-title">
          <h2>Income Information</h2>
          <p class="step-description">Financial details for policy assessment</p>
        </div>
      </div>
      <div class="form-grid">
        <div class="form-field">
          <label for="incomeSource">Income Source <span class="required">*</span></label>
          <input 
            pInputText 
            type="text" 
            formControlName="incomeSource"
            id="incomeSource"
            placeholder="e.g., Salary, Business">
          <small class="error-text" *ngIf="f['incomeSource'].invalid && (f['incomeSource'].dirty || f['incomeSource'].touched)">
            Income source is required
          </small>
        </div>

        <div class="form-field">
          <label for="totalIncome">Total Annual Income <span class="required">*</span></label>
          <p-inputNumber 
            formControlName="totalIncome"
            inputId="totalIncome"
            mode="currency"
            currency="USD"
            locale="en-US"
            placeholder="Enter income">
          </p-inputNumber>
          <small class="error-text" *ngIf="f['totalIncome'].invalid && (f['totalIncome'].dirty || f['totalIncome'].touched)">
            <span *ngIf="f['totalIncome'].errors?.['required']">Total income is required</span>
            <span *ngIf="f['totalIncome'].errors?.['min']">Must be greater than 0</span>
          </small>
        </div>
      </div>
    </div>

    <!-- Step 4: Nominee Information -->
    <div class="form-section" *ngIf="currentStep === 3 || isViewMode">
      <div class="section-header">
        <div class="step-indicator">
          <span class="step-number">4</span>
        </div>
        <div class="section-title">
          <h2>Nominee Information</h2>
          <p class="step-description">Beneficiary details for the policy</p>
        </div>
      </div>
      <div class="form-grid">
        <div class="form-field full-width">
          <label for="nomineeName">Nominee Name <span class="required">*</span></label>
          <input 
            pInputText 
            type="text" 
            formControlName="nomineeName"
            id="nomineeName"
            placeholder="Enter nominee name">
          <small class="error-text" *ngIf="f['nomineeName'].invalid && (f['nomineeName'].dirty || f['nomineeName'].touched)">
            <span *ngIf="f['nomineeName'].errors?.['required']">Nominee name is required</span>
            <span *ngIf="f['nomineeName'].errors?.['minlength']">Minimum 3 characters</span>
          </small>
        </div>

        <div class="form-field">
          <label for="nomineeContactNumber">Contact Number <span class="required">*</span></label>
          <input 
            pInputText 
            type="text" 
            formControlName="nomineeContactNumber"
            id="nomineeContactNumber"
            placeholder="10-digit number">
          <small class="error-text" *ngIf="f['nomineeContactNumber'].invalid && (f['nomineeContactNumber'].dirty || f['nomineeContactNumber'].touched)">
            <span *ngIf="f['nomineeContactNumber'].errors?.['required']">Contact is required</span>
            <span *ngIf="f['nomineeContactNumber'].errors?.['pattern']">Must be 10 digits</span>
          </small>
        </div>

        <div class="form-field">
          <label for="nomineeDOB">Date of Birth <span class="required">*</span></label>
          <p-calendar 
            formControlName="nomineeDOB"
            inputId="nomineeDOB"
            [showIcon]="true"
            dateFormat="yy-mm-dd"
            [maxDate]="maxDate"
            placeholder="Select date">
          </p-calendar>
          <small class="error-text" *ngIf="f['nomineeDOB'].invalid && (f['nomineeDOB'].dirty || f['nomineeDOB'].touched)">
            Date of birth is required
          </small>
        </div>

        <div class="form-field">
          <label for="nomineeRelationship">Relationship <span class="required">*</span></label>
          <p-dropdown 
            formControlName="nomineeRelationship"
            inputId="nomineeRelationship"
            [options]="nomineeRelationships" 
            optionLabel="label" 
            optionValue="value"
            placeholder="Select Relationship">
          </p-dropdown>
          <small class="error-text" *ngIf="f['nomineeRelationship'].invalid && (f['nomineeRelationship'].dirty || f['nomineeRelationship'].touched)">
            Relationship is required
          </small>
        </div>
      </div>
    </div>

    <!-- Form Actions -->
    <div class="form-actions">
      <p-button 
        type="button" 
        [label]="isViewMode ? 'Back to Policies' : 'Cancel'" 
        severity="secondary"
        (click)="cancel()"
        icon="pi pi-times">
      </p-button>
      
      <div class="step-navigation" *ngIf="!isViewMode">
        <p-button 
          *ngIf="currentStep > 0"
          type="button" 
          label="Previous" 
          severity="secondary"
          (click)="previousStep()"
          icon="pi pi-angle-left">
        </p-button>
        
        <p-button 
          *ngIf="currentStep < 3"
          type="button" 
          label="Next" 
          (click)="nextStep()"
          icon="pi pi-angle-right"
          iconPos="right">
        </p-button>
        
        <p-button 
          *ngIf="currentStep === 3"
          type="submit" 
          [label]="loading ? 'Saving...' : (isEditMode ? 'Update Policy' : 'Create Policy')" 
          [disabled]="loading || policyForm.invalid"
          [loading]="loading"
          icon="pi pi-check">
        </p-button>
      </div>
    </div>
  </form>
</div>